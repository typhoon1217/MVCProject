<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="CAL_TOTALSALES" directorySegmentName="seg_0" id="A5F6DCCC-0AF9-7ACE-5AA3-C69B9D9130CA">
<sourceConnName>로컬-MVCREST</sourceConnName>
<sourceObjSchema>MVCREST</sourceObjSchema>
<sourceObjName>CAL_TOTALSALES</sourceObjName>
<createdBy>vhrpe</createdBy>
<createdTime>2024-05-13 13:21:27 UTC</createdTime>
<ownerDesignName>UPDATE</ownerDesignName>
<actions>INSERT</actions>
<body><![CDATA[DECLARE
    v_year_month VARCHAR2(6);
BEGIN
    -- yyyy/mm 형태의 년도와 월을 문자열로 추출
    v_year_month := TO_CHAR(:NEW.transaction_time, 'YYMM');

    -- 해당 월에 대한 매출이 이미 존재하는지 확인
    -- 없으면 새로운 레코드를 삽입, 있으면 기존 레코드 업데이트
    BEGIN
        INSERT INTO TotalSales (sales_month, sales_income, sales_expense, sales_netProfit)
        VALUES (v_year_month, 
                CASE WHEN :NEW.transaction_amount > 0 THEN :NEW.transaction_amount ELSE 0 END, -- 수입이면 양수 값만 계산
                CASE WHEN :NEW.transaction_amount < 0 THEN :NEW.transaction_amount ELSE 0 END, -- 지출이면 음수 값만 계산
                :NEW.transaction_amount); -- 초기값으로 transaction_amount로 설정
    EXCEPTION
        WHEN DUP_VAL_ON_INDEX THEN
            UPDATE TotalSales
            SET sales_income = sales_income + CASE WHEN :NEW.transaction_amount > 0 THEN :NEW.transaction_amount ELSE 0 END,
                sales_expense = sales_expense + CASE WHEN :NEW.transaction_amount < 0 THEN :NEW.transaction_amount ELSE 0 END,
                sales_netProfit = sales_netProfit + :NEW.transaction_amount
            WHERE sales_month = v_year_month;
    END;
END;]]></body>
<triggerTime>AFTER</triggerTime>
<owner>7BB54472-A5B2-D6C0-5294-B7A0AA8D59E4</owner>
<table>9DEB5D17-9C9B-03ED-4A08-C7E66F34271F</table>
</TriggerOraclev10g>